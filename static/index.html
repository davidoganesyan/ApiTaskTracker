<!DOCTYPE html>
<html>
<head>
    <title>Дерево задач</title>
    <style>
        .task-description {
            display: block;
            width: 100%;
            margin: 8px 0;
            white-space: pre-wrap; /* Сохраняет переносы строк */
            word-wrap: break-word;
            font-size: 0.9em;
            color: #333;
        }
        .task-node {
            position: relative; /* Обязательно для позиционирования дочерних элементов */
            padding-bottom: 40px; /* Добавьте отступ снизу для кнопки */
        }

        .delete-btn-container {
            position: absolute;
            right: 15px; /* Отступ справа */
            bottom: 10px; /* Отступ снизу */
            display: none; /* Кнопка появляется при наведении */
        }

        .task-node:hover .delete-btn-container {
            display: block; /* Показываем кнопку при наведении */
        }
        .delete-btn-container {
            z-index: 10; /* Чтобы кнопка была поверх других элементов */
        }
        /* Кнопки действий */
        .task-actions {
            margin-top: 8px;
            display: flex;
            gap: 8px;
        }
        .task-action-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8em;
        }
        .edit-btn {
            background: #ffc107;
            color: black;
        }
        .delete-btn {
            background: #dc3545;
            color: white;
        }
        /* Модальное окно */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 50%;
            border-radius: 5px;
        }
        .close {
            float: right;
            cursor: pointer;
            font-size: 1.5em;
        }
        .tree ul {
            list-style: none;
            padding-left: 20px;
        }
        .task-node {
            cursor: pointer;
            padding: 12px;
            border: 1px solid #ddd;
            margin: 5px 0;
            border-radius: 4px;
            position: relative;
        }
        .task-node:hover {
            background-color: #f0f0f0;
        }
        .collapsed {
            display: none;
        }
        .task-node small {
            font-size: 0.8em;
            color: #666;
            display: block;
            margin-top: 4px;
        }
        .overdue {
            background-color: #ffe6e6 !important;
        }
        .assignee-status {
            font-weight: bold;
            margin-left: 5px;
            text-transform: uppercase;
            font-size: 0.7em;
            padding: 2px 5px;
            border-radius: 3px;
        }
        .assignee-status.pending {
            color: #999;
            background: #f0f0f0;
        }
        .assignee-status.completed {
            color: #198754;
            background: #d4edda;
        }
    </style>
</head>
<body>
<div id="task-tree"></div>
<button class="task-action-btn" style="margin-bottom: 20px" onclick="openCreateModal()">+ Создать задачу</button>


<!-- Модальное окно создания -->
<div id="createModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeCreateModal()">&times;</span>
        <h3>Создать задачу</h3>
        <form id="createTaskForm">
            <label>Название:</label>
            <input type="text" id="createTitle" required>

            <label>Описание:</label>
            <textarea id="createDescription" required></textarea>

            <label>Срок:</label>
            <input type="datetime-local" id="createEndDate">

            <label>Родительская задача (ID):</label>
            <input type="number" id="createParentId" placeholder="Оставьте пустым для корневой задачи">

            <label>Автор:</label>
            <select id="createAuthor" required></select>

            <label>Исполнители:</label>
            <select id="createAssignees" multiple size="3"></select>

            <button type="submit">Создать</button>
        </form>
    </div>
</div>

<!-- Модальное окно редактирования -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeEditModal()">&times;</span>
        <h3>Редактировать задачу</h3>
        <form id="editTaskForm">
            <input type="hidden" id="editTaskId">
            <label>Название:</label>
            <input type="text" id="editTitle" required>
            <label>Описание:</label>
            <textarea id="editDescription" required></textarea>
            <label>Срок:</label>
            <input type="datetime-local" id="editEndDate">
            <label>Статус:</label>
            <select id="editStatus">
                <option value="pending">В ожидании</option>
                <option value="in_progress">В процессе</option>
                <option value="completed">Завершено</option>
            </select>
            <label>Исполнители:</label>
            <select id="editAssignees" multiple size="3"></select>
            <button type="submit">Сохранить</button>
        </form>
    </div>
</div>

<script>
    let allUsers = [];

    async function loadUsers() {
        const response = await fetch('/api/users');
        allUsers = await response.json();
    }

    document.addEventListener('DOMContentLoaded', async () => {
        await loadUsers();
        const response = await fetch('/api/tasks');
        const tasks = await response.json();
        const treeContainer = document.getElementById('task-tree');
        treeContainer.appendChild(buildTree(tasks));
    });

    function buildTree(tasks) {
        const ul = document.createElement('ul');
        tasks.forEach(task => {
            const li = document.createElement('li');
            li.className = 'task-node';
            li.setAttribute('data-task-id', task.id);

            // Контейнер для кнопок действий
            const actions = document.createElement('div');
            actions.className = 'task-actions';

            // Кнопка редактирования
            const editBtn = document.createElement('button');
            editBtn.className = 'task-action-btn edit-btn';
            editBtn.textContent = 'Редактировать';
            editBtn.onclick = (e) => {
                e.stopPropagation();
                openEditModal(task.id);
            };

            // Кнопка удаления
            const deleteBtnContainer = document.createElement('div');
            deleteBtnContainer.className = 'delete-btn-container';

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'task-action-btn delete-btn';
            deleteBtn.textContent = 'Удалить';
            deleteBtn.onclick = (e) => {
                e.stopPropagation();
                if(confirm('Удалить задачу?')) {
                    deleteTask(task.id);
                }
            };

            deleteBtnContainer.appendChild(deleteBtn);
            li.appendChild(deleteBtnContainer); // Кнопка добавляется отдельно

            actions.appendChild(editBtn);
            actions.appendChild(deleteBtn);
            li.appendChild(actions);

            // Проверка просрочки
            const isOverdue = task.end_date && new Date(task.end_date) < new Date();
            if (isOverdue) li.classList.add('overdue');

            // Заголовок задачи
            const header = document.createElement('div');
            header.innerHTML = `
                <div style="display: flex; justify-content: space-between">
                    <span>${task.title}</span>
                    <small>
                        Создано: ${formatDate(task.created_at)}
                        ${task.end_date ? ` | Срок: ${formatDate(task.end_date)}` : ''}
                        <br>
                        <strong>Автор:</strong> ${task.author.name} ${task.author.surname}
                        <br>
                        <strong>Статус:</strong> ${task.status}
                        <strong>Исполнители:</strong>
                        ${task.assignees.length > 0
                            ? task.assignees.map(a =>
                                `${a.user.name} ${a.user.surname}
                                <span class="assignee-status ${a.assignee_status}">
                                    ${a.assignee_status}
                                </span>`
                            ).join(', ')
                            : 'Не назначены'
                        }
                    </small>
                </div>
                <div class="task-description">${task.description}</div>
            `;
            header.style.cursor = 'pointer';
            header.onclick = () => toggleChildren(li);
            li.appendChild(header);

            // Дочерние задачи
            if (task.children.length > 0) {
                const childrenContainer = document.createElement('div');
                childrenContainer.className = 'collapsed';
                childrenContainer.appendChild(buildTree(task.children));
                li.appendChild(childrenContainer);
            }

            ul.appendChild(li);
        });
        return ul;
    }

    function toggleChildren(node) {
        const children = node.querySelector('.collapsed');
        if (children) {
            children.style.display = children.style.display === 'none' ? 'block' : 'none';
        }
    }

    function formatDate(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        return date.toLocaleDateString('ru', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    async function deleteTask(taskId, element) {
        try {
            await fetch(`/api/tasks/${taskId}`, { method: 'DELETE' });
            element.remove();
        } catch (error) {
            console.error('Ошибка удаления:', error);
        }
    }

    async function openEditModal(taskId) {
        const response = await fetch(`/api/tasks/${taskId}`);
        const task = await response.json();

        document.getElementById('editTaskId').value = task.id;
        document.getElementById('editTitle').value = task.title;
        document.getElementById('editDescription').value = task.description;
        document.getElementById('editEndDate').value = task.end_date
            ? new Date(task.end_date).toISOString().slice(0, 16)
            : '';
        document.getElementById('editStatus').value = task.status;

        // Заполнение исполнителей
        const assigneeSelect = document.getElementById('editAssignees');
        assigneeSelect.innerHTML = '';
        allUsers.forEach(user => {
            const option = document.createElement('option');
            option.value = user.id;
            option.textContent = `${user.name} ${user.surname}`;
            if(task.assignees.some(a => a.user.id === user.id)) {
                option.selected = true;
            }
            assigneeSelect.appendChild(option);
        });

        document.getElementById('editModal').style.display = 'block';
    }

    function closeEditModal() {
        document.getElementById('editModal').style.display = 'none';
    }

    async function handleEditSubmit(e) {
        e.preventDefault();
        const taskId = document.getElementById('editTaskId').value;
        const updatedData = {
            title: document.getElementById('editTitle').value,
            description: document.getElementById('editDescription').value,
            end_date: document.getElementById('editEndDate').value,
            status: document.getElementById('editStatus').value,
            assignee_user_ids: Array.from(
                document.getElementById('editAssignees').selectedOptions
            ).map(opt => parseInt(opt.value))
        };

        try {
            const response = await fetch(`/api/tasks/${taskId}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updatedData)
            });

            if (response.ok) {
                const updatedTask = await response.json();
                updateTaskInTree(updatedTask);
                closeEditModal();
            }
        } catch (error) {
            console.error('Ошибка обновления:', error);
        }
    }

    function updateTaskInTree(updatedTask) {
        const taskElement = document.querySelector(`[data-task-id="${updatedTask.id}"]`);
        if (taskElement) {
            const header = taskElement.querySelector('div > div');
            header.innerHTML = `
                <div style="display: flex; justify-content: space-between">
                    <span>${updatedTask.title}</span>
                    <small>
                        Создано: ${formatDate(updatedTask.created_at)}
                        ${updatedTask.end_date ? ` | Срок: ${formatDate(updatedTask.end_date)}` : ''}
                        <br>
                        <strong>Описание:</strong> ${updatedTask.description}
                        <br>
                        <strong>Автор:</strong> ${updatedTask.author.name} ${updatedTask.author.surname}
                        <br>
                        <strong>Исполнители:</strong>
                        ${updatedTask.assignees.length > 0
                            ? updatedTask.assignees.map(a =>
                                `${a.user.name} ${a.user.surname}
                                <span class="assignee-status ${a.assignee_status}">
                                    ${a.assignee_status}
                                </span>`
                            ).join(', ')
                            : 'Не назначены'
                        }
                    </small>
                </div>
            `;

            // Обновление статуса просрочки
            const isOverdue = updatedTask.end_date && new Date(updatedTask.end_date) < new Date();
            taskElement.classList.toggle('overdue', isOverdue);
        }
    }


        // Функция открытия модального окна создания
    function openCreateModal() {
        const authorSelect = document.getElementById('createAuthor');
        const assigneeSelect = document.getElementById('createAssignees');

        // Заполняем авторов и исполнителей
        authorSelect.innerHTML = '';
        assigneeSelect.innerHTML = '';
        allUsers.forEach(user => {
            // Для автора
            const authorOption = document.createElement('option');
            authorOption.value = user.id;
            authorOption.textContent = `${user.name} ${user.surname}`;
            authorSelect.appendChild(authorOption);

            // Для исполнителей
            const assigneeOption = document.createElement('option');
            assigneeOption.value = user.id;
            assigneeOption.textContent = `${user.name} ${user.surname}`;
            assigneeSelect.appendChild(assigneeOption);
        });

        document.getElementById('createModal').style.display = 'block';
    }

    // Обработчик формы создания
    document.getElementById('createTaskForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const newTask = {
            title: document.getElementById('createTitle').value,
            description: document.getElementById('createDescription').value,
            end_date: document.getElementById('createEndDate').value,
            parent_id: document.getElementById('createParentId').value || null,
            author_id: document.getElementById('createAuthor').value,
            assignee_user_ids: Array.from(
                document.getElementById('createAssignees').selectedOptions
            ).map(opt => parseInt(opt.value))
        };

        try {
            const response = await fetch('/api/tasks', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(newTask)
            });

            if (response.ok) {
                closeCreateModal();
                location.reload(); // Перезагрузка для обновления дерева
            }
        } catch (error) {
            console.error('Ошибка создания:', error);
        }
    });

    function closeCreateModal() {
        document.getElementById('createModal').style.display = 'none';
    }


    document.getElementById('editTaskForm').addEventListener('submit', handleEditSubmit);


</script>
</body>
</html>